<!doctype html>
<html>
<body>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<style>
    body {
        
    }
    .wrapper {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        grid-template-rows: auto;
        grid-template-areas: "left center right";
        padding-top: 10px;
    }
    .grid-left {
        grid-area: left;
    }
    .grid-center {
        grid-area: center;
        text-align: center;
    }
    .grid-right {
        padding: 10px;
        grid-area: right;
    }
    #game-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        grid-template-areas: 
            "game game" 
            "game-panel-left game-panel-right";
        padding: 5px;
        background-color: #000;
        box-shadow: 0px 18px 18px #888888;
        position: relative;
    }
    #game {
        grid-area: game;
    }
    .panel {
        color: #fff;
    }
    #game-panel-left {
        grid-area: game-panel-left;
    }
    #game-panel-right {
        grid-area: game-panel-right;
    }
    #g {
        margin: auto;
        background-color: #fff;
        border: 1px solid #000;
    }
    .game-modal {
        position: absolute;
        border: 1px solid #000;
        background-color: #fff;
        padding: 20px;
    }
    .game-modal > div {
        font-size: 20px;
        font-weight: bold;
    }
    .game-modal > button {
        margin-top: 5px;
        border: 1px solid #000;
        background-color: #fff;
        padding: 7px;
    }
    .game-modal > button:hover {
        background-color: #000;
        color: #fff;
        cursor: pointer;
    }
    #start-modal {
        z-index: 3;
        top: 35%;
        left: 32%;
        display: block;
    }
    #pause-modal {
        z-index: 3;
        top: 35%;
        left: 29%;
        display: none;
    }
    #gameOver-modal {
        z-index: 3;
        top: 35%;
        left: 32%;
        display: none;
    }
    #highScore-modal {
        z-index: 4;
        top: 30%;
        left: 6%;
        display: none;
    }
</style>
</head>
<button id="send">tttt</button><br />
<div class="wrapper">
    <div class="grid-left">
        
    </div>
    <div class="grid-center">
        <div id="game-wrapper">
            <div id="game">
                <div class="game-modal" id="start-modal">
                    <div>NEW GAME</div>
                    <button onclick="Module.start()">Start</button>
                </div>
                <div class="game-modal" id="pause-modal">
                    <div>GAME PAUSED</div>
                    Press "p" to continue.
                </div>
                <div class="game-modal" id="gameOver-modal">
                    <div>GAME OVER</div>
                    <button onclick="Module.reset()">Retry</button>
                </div>
                <div class="game-modal" id="highScore-modal">
                    <div>NEW HIGH SCORE</div>
                    Name: <input id="newHighScoreNameInput" type="text" />
                    <button onclick="Module.setNewHighScore()">Sumbit score</button>
                </div>
                <canvas id="g"></canvas>
            </div>
            <div id="game-panel-left" class="panel">
                Score: <span id="score">0</span>
            </div>
            <div id="game-panel-right" class="panel">

            </div>
        </div>
    </div>
    <div class="grid-right">
        Leaderboard:
        <table id="leaderboard">
            <tr>
                <th>Score</th>
                <th>Name</th>
                <th>Since</th>
            </tr>
        </table>
    </div>
</div>
<script>

$('#send').on('click', (e) => {
    e.preventDefault();
    $.ajax({
        method: "GET",
        url: "/",
        data: {
            insertIntoLeaderboard: "1",
            // test: "1",
            name: "test2",
            score: 3,
            added: "2019-04-22"
        },
        success: function(res) {
            console.log(res);
            // let response = JSON.parse(res);
            // console.log(response);
        },
        error: function(res) {
            console.log(res);
        }
    });
});

class Game {

    constructor(args) {
        this.width = args.width;
        this.height = args.height;
        this.gameOver = false;
        this.score = 0;
        this.leaderboard = null;
        this.paused = true;
    }

    getLeaderboard() {

        let self = this;

        $.ajax({
            method: "GET",
            url: "/",
            data: {
                getLeaderboard: "1"
            },
            success: function(res) {
                
                $(".leaderboard-record").remove();
                
                let response = JSON.parse(res),
                    leaderboard = response.leaderboard,
                    leaderboardTable = $("#leaderboard");

                leaderboard.pop();

                leaderboard.forEach((record, i) => {

                    // Show only 10 results. 
                    if (i > 9) return;
                    
                    let tr = $("<tr/>").attr("class", "leaderboard-record"),
                        scoreTd = $("<td/>").html(record.score),
                        nameTd = $("<td/>").html(record.name),
                        addedTd = $("<td/>").html(record.added.replace(/\s\d+:\d+:\d+/, ''));
                    $(tr).append(scoreTd, nameTd, addedTd);

                    $(leaderboardTable).append(tr);

                });

                self.leaderboard = leaderboard;
                
            },
            error: function(res) {
                console.log(res);
            }
        });
   
    }

    getScore() {
        return this.score;
    }

    init() {
        $('#g').attr({
            "width": this.width,
            "height": this.height
        });
        this.setKeyBindings();
        this.getLeaderboard();
    }

    isGameOver() {
        return this.gameOver;
    }

    isNewHighScore() {
        return this.score > (this.leaderboard.length > 0 ? Number(this.leaderboard[0].score) : 0);
    }

    onRuntimeInitialized() {

        this.gameInstance = new Module.Game(this.width, this.height);

        let self = this;

        requestAnimationFrame(function f() {
            self.gameInstance.update();
            requestAnimationFrame(f);
            self.parseState();
        });

    }

    parseState() {
        let state = this.gameInstance.getState();
        this.setScore(state.score);
        this.setGameOver(state.isGameOver);
    }

    pause() {
        this.paused = true;
        this.gameInstance.setPaused(true);
        $("#pause-modal").css("display", "block");
    }

    reset() {
        this.gameInstance.reset();
        this.getLeaderboard();
    }

    setGameOver(val) {
        if (!this.gameOver && val) {
            if (this.isNewHighScore()) {
                $("#highScore-modal").css("display", "block");
            }
            $("#gameOver-modal").css("display", "block");
        } 
        if (this.gameOver && !val) {
            $("#gameOver-modal").css("display", "none");
        }
        this.gameOver = val;
    }

    setKeyBindings() {
        let self = this;

        document.addEventListener("keydown", function(event) {

            switch (event.which) {
                case 65:
                    !self.gameOver && !self.paused && self.gameInstance.moveSquareSet(true);
                    break;
                case 68:
                    !self.gameOver && !self.paused && self.gameInstance.moveSquareSet(false);
                    break;
                case 87:
                    !self.gameOver && !self.paused && self.gameInstance.rotateSquareSet();
                    break;
                case 80:
                    !self.gameOver && !self.paused ? self.pause() : self.unPause();
                    break;
            }

        });

    }

    setNewHighScore() {
            
        let self = this;
            
        $.ajax({
            method: "GET",
            url: "/",
            data: {
                insertIntoLeaderboard: "1",
                name: $("#newHighScoreNameInput").val() != "" ? $("#newHighScoreNameInput").val() : "Unknown player",
                score: self.score,
                added: new Date().toJSON().slice(0,10)
            },
            success: function(res) {
                $("#highScore-modal").css("display", "none");
                self.getLeaderboard();
            },
            error: function(res) {
                console.log(res);
            }
        });

    }

    setScore(newScore) {
        this.score = newScore;
        $("#score").html(this.score);
    }

    start() {
        this.unPause();
        $("#start-modal").css("display", "none");
    }

    unPause() {
        this.paused = false;
        this.gameInstance.setPaused(false);
        $("#pause-modal").css("display", "none");
    }

}

var Module = new Game({
        width: 400,
        height: 400
    });
Module.init();

</script>
<script src="client/app.js"></script>
</body>
</html>